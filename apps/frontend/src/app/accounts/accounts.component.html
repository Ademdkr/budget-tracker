<div class="accounts-container">
  <!-- Header -->
  <div class="accounts-header">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon>account_balance_wallet</mat-icon>
        Konten
      </h1>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="addAccount()">
          <mat-icon>add</mat-icon>
          Konto hinzufügen
        </button>
        <button
          mat-icon-button
          [matTooltip]="viewMode === 'cards' ? 'Tabellenansicht' : 'Kartenansicht'"
          (click)="toggleViewMode()"
        >
          <mat-icon>{{ viewMode === 'cards' ? 'table_view' : 'view_module' }}</mat-icon>
        </button>
      </div>
    </div>

    <!-- Summary -->
    <div class="accounts-summary">
      <mat-card class="summary-card">
        <mat-card-content>
          <div class="summary-content">
            <div class="summary-item">
              <mat-icon class="summary-icon">account_balance_wallet</mat-icon>
              <div class="summary-details">
                <span class="summary-label">Gesamtvermögen</span>
                <span class="summary-value" [ngClass]="getBalanceClass(getTotalBalance())">
                  {{ formatCurrency(getTotalBalance()) }}
                </span>
              </div>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-item">
              <mat-icon class="summary-icon">account_balance</mat-icon>
              <div class="summary-details">
                <span class="summary-label">Aktive Konten</span>
                <span class="summary-value">{{ getActiveAccountsCount() }}</span>
              </div>
            </div>
            <div class="summary-divider" *ngIf="hasAccountSelection()"></div>
            <div class="summary-item" *ngIf="hasAccountSelection()">
              <mat-icon class="summary-icon selected-icon">check_circle</mat-icon>
              <div class="summary-details">
                <span class="summary-label">Ausgewähltes Konto</span>
                <span class="summary-value selected-account">{{ getSelectedAccountName() }}</span>
              </div>
              <button
                mat-icon-button
                (click)="clearAccountSelection()"
                matTooltip="Auswahl aufheben"
                class="clear-selection-btn"
              >
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-card class="loading-card">
      <mat-card-content>
        <div class="loading-content">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Konten werden geladen...</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Error State -->
  <div *ngIf="hasError" class="error-container">
    <mat-card class="error-card">
      <mat-card-content>
        <div class="error-content">
          <mat-icon class="error-icon">error_outline</mat-icon>
          <h3>Fehler beim Laden</h3>
          <p>Die Konten konnten nicht geladen werden.</p>
          <button mat-raised-button color="primary" (click)="retry()">
            <mat-icon>refresh</mat-icon>
            Erneut versuchen
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Empty State -->
  <div *ngIf="isEmpty && !isLoading && !hasError" class="empty-container">
    <mat-card class="empty-card">
      <mat-card-content>
        <div class="empty-content">
          <mat-icon class="empty-icon">account_balance_wallet</mat-icon>
          <h3>Keine Konten gefunden</h3>
          <p>Fügen Sie Ihr erstes Konto hinzu, um zu beginnen.</p>
          <button mat-raised-button color="primary" (click)="addAccount()">
            <mat-icon>add</mat-icon>
            Erstes Konto hinzufügen
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && !hasError && !isEmpty" class="accounts-content">
    <!-- Cards View -->
    <div *ngIf="viewMode === 'cards'" class="accounts-cards">
      <div *ngFor="let typeId of Object.keys(getAccountsByType())" class="account-type-section">
        <h2 class="type-title">
          <mat-icon [style.color]="getAccountTypeInfo(typeId)?.color">
            {{ getAccountTypeInfo(typeId)?.icon }}
          </mat-icon>
          {{ getAccountTypeInfo(typeId)?.name }}
          <mat-chip class="count-chip">{{ getAccountsByType()[typeId].length }}</mat-chip>
        </h2>

        <div class="accounts-grid">
          <mat-card
            *ngFor="let account of getAccountsByType()[typeId]"
            class="account-card"
            [class.selected]="isAccountSelected(account.id)"
          >
            <mat-card-header>
              <div class="header-content-wrapper">
                <div
                  class="account-avatar"
                  [style.background-color]="getAccountTypeInfo(account.type)?.color"
                >
                  <mat-icon>{{ getAccountTypeInfo(account.type)?.icon }}</mat-icon>
                </div>
                <div class="header-text">
                  <mat-card-title>{{ account.name }}</mat-card-title>
                  <mat-card-subtitle>{{
                    getAccountTypeInfo(account.type)?.name
                  }}</mat-card-subtitle>
                </div>
              </div>
              <button mat-icon-button [matMenuTriggerFor]="accountMenu" class="account-menu">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #accountMenu="matMenu">
                <button
                  mat-menu-item
                  (click)="selectAccount(account)"
                  *ngIf="!isAccountSelected(account.id)"
                >
                  <mat-icon>check_circle_outline</mat-icon>
                  Konto auswählen
                </button>
                <button
                  mat-menu-item
                  (click)="clearAccountSelection()"
                  *ngIf="isAccountSelected(account.id)"
                >
                  <mat-icon>cancel</mat-icon>
                  Auswahl aufheben
                </button>
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="editAccount(account)">
                  <mat-icon>edit</mat-icon>
                  Bearbeiten
                </button>
                <button mat-menu-item (click)="manageCategoriesForAccount(account)">
                  <mat-icon>category</mat-icon>
                  Kategorien verwalten
                </button>
                <button mat-menu-item (click)="deleteAccount(account)" class="delete-action">
                  <mat-icon>delete</mat-icon>
                  Löschen
                </button>
              </mat-menu>
            </mat-card-header>

            <mat-card-content>
              <div class="account-balance">
                <span class="balance-label">Aktueller Saldo</span>
                <span class="balance-value" [ngClass]="getBalanceClass(account.currentBalance)">
                  {{ formatCurrency(account.currentBalance) }}
                </span>
              </div>

              <div class="account-stats">
                <div class="stat-item">
                  <mat-icon>receipt</mat-icon>
                  <span class="stat-label">Transaktionen</span>
                  <span class="stat-value">{{ account.transactionCount }}</span>
                </div>
                <div class="stat-item">
                  <mat-icon>schedule</mat-icon>
                  <span class="stat-label">Letzte Aktivität</span>
                  <span class="stat-value">{{
                    getTimeSinceLastTransaction(account.lastTransactionDate)
                  }}</span>
                </div>
              </div>

              <div *ngIf="account.note" class="account-note">
                <mat-icon>note</mat-icon>
                <span>{{ account.note }}</span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </div>

    <!-- Table View -->
    <div *ngIf="viewMode === 'table'" class="accounts-table">
      <mat-card class="table-card">
        <mat-card-header>
          <mat-card-title>Alle Konten</mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <div class="table-container">
            <table mat-table [dataSource]="getActiveAccounts()" class="accounts-data-table">
              <!-- Name Column -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef>Konto</th>
                <td mat-cell *matCellDef="let account">
                  <div class="account-cell">
                    <div
                      class="account-avatar small"
                      [style.background-color]="getAccountTypeInfo(account.type)?.color"
                    >
                      <mat-icon>{{ getAccountTypeInfo(account.type)?.icon }}</mat-icon>
                    </div>
                    <div class="account-details">
                      <span class="account-name">{{ account.name }}</span>
                      <span class="account-note" *ngIf="account.note">{{ account.note }}</span>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Type Column -->
              <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef>Typ</th>
                <td mat-cell *matCellDef="let account">
                  <mat-chip
                    class="type-chip"
                    [style.background-color]="getAccountTypeInfo(account.type)?.color + '20'"
                    [style.color]="getAccountTypeInfo(account.type)?.color"
                  >
                    {{ getAccountTypeInfo(account.type)?.name }}
                  </mat-chip>
                </td>
              </ng-container>

              <!-- Balance Column -->
              <ng-container matColumnDef="balance">
                <th mat-header-cell *matHeaderCellDef>Saldo</th>
                <td mat-cell *matCellDef="let account">
                  <span class="balance-amount" [ngClass]="getBalanceClass(account.currentBalance)">
                    {{ formatCurrency(account.currentBalance) }}
                  </span>
                </td>
              </ng-container>

              <!-- Transactions Column -->
              <ng-container matColumnDef="transactions">
                <th mat-header-cell *matHeaderCellDef>Transaktionen</th>
                <td mat-cell *matCellDef="let account">
                  <span class="transaction-count">{{ account.transactionCount }}</span>
                </td>
              </ng-container>

              <!-- Last Activity Column -->
              <ng-container matColumnDef="lastActivity">
                <th mat-header-cell *matHeaderCellDef>Letzte Aktivität</th>
                <td mat-cell *matCellDef="let account">
                  <div class="activity-cell">
                    <span class="activity-date">{{ formatDate(account.lastTransactionDate) }}</span>
                    <span class="activity-relative">{{
                      getTimeSinceLastTransaction(account.lastTransactionDate)
                    }}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Aktionen</th>
                <td mat-cell *matCellDef="let account">
                  <div class="actions-cell">
                    <button
                      mat-icon-button
                      *ngIf="!isAccountSelected(account.id)"
                      (click)="selectAccount(account)"
                      matTooltip="Konto auswählen"
                      color="primary"
                    >
                      <mat-icon>check_circle_outline</mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      *ngIf="isAccountSelected(account.id)"
                      (click)="clearAccountSelection()"
                      matTooltip="Auswahl aufheben"
                      color="accent"
                    >
                      <mat-icon>check_circle</mat-icon>
                    </button>
                    <button mat-icon-button (click)="editAccount(account)" matTooltip="Bearbeiten">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      (click)="manageCategoriesForAccount(account)"
                      matTooltip="Kategorien verwalten"
                    >
                      <mat-icon>category</mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      color="warn"
                      (click)="deleteAccount(account)"
                      matTooltip="Löschen"
                    >
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: displayedColumns"
                class="account-row"
                [class.selected]="isAccountSelected(row.id)"
              ></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
